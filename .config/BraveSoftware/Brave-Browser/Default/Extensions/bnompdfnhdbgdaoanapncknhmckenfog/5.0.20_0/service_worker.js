var window={},refresh_contentscripts=(importScripts("lib/global.js"),importScripts("lib/xtion.js"),importScripts("lib/analytics.js"),window.BACKGROUND=1,chrome.action.setBadgeBackgroundColor({color:"#00709f"}),chrome.runtime.onMessage.addListener(function(e,t,o){switch(e.a){case"request":return e.options.error&&(e.options.error=function(e){o({a:"error",e:e})}),Xtion_fetch(e.url,o,e.options),!0;case"cookie":return chrome.cookies.get(e.details,function(e){o(e?e.value:null)}),!0;case"cookie_set":return chrome.cookies.set(e.details,o),!0;case"activated":chrome.action.setIcon({path:"image/icon.38.png",tabId:t.tab.id});break;case"badge_clear":chrome.action.setBadgeText({text:""});break;case"background_storage_set":"email_ids"===e.key?chrome.storage.local.set({[e.key]:e.value},Generate_netrequest_rules):chrome.storage.local.set({[e.key]:e.value}),o&&o();break;case"feed_sync":Feed_sync();break;case"detector_options_page":chrome.tabs.create({url:chrome.runtime.getURL("detector_options.html")});break;case"detector_config_update":Generate_netrequest_rules(),chrome.tabs.query({},e=>{for(const t of e)t.id&&t.url&&!t.url.startsWith("chrome://")&&chrome.tabs.sendMessage(t.id,{a:"detector_config_update"})});break;case"outlook_tab_disable_images":chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t.tab.id],addRules:[{action:{type:"block"},priority:1,id:t.tab.id,condition:Xtion_object_merge({tabIds:[t.tab.id],resourceTypes:["image"]},e.owa?{}:{initiatorDomains:["outlook.live.com","outlook.office.com","outlook.office365.com"]})}]});function i(e){e&&0!==e.frameId||e!==t.tab.id&&e?.tabId!==t.tab.id||(chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t.tab.id]}),chrome.tabs.onRemoved.removeListener(i),chrome.webNavigation.onCommitted.removeListener(i))}chrome.tabs.onRemoved.addListener(i),chrome.webNavigation.onCommitted.addListener(i);break;case"alive":return o(1),!0}}),chrome.runtime.onInstalled.addListener(function(e){"install"===e.reason?TESTING||(chrome.tabs.create({url:window.LOCATION_MAIN+"instructions"}),analytics_google.fireEvent("install")):"update"===e.reason&&(parseFloat(e.previousVersion)<2.92&&chrome.cookies.remove({url:window.LOCATION_ACTION,name:"user"}),2===parseInt(e.previousVersion))&&Storage_get("email_ids",function(e){e||chrome.offscreen.createDocument({url:chrome.runtime.getURL("offscreen.html"),reasons:[chrome.offscreen.Reason.LOCAL_STORAGE],justification:"LOCAL_STORAGE"},function(){chrome.runtime.sendMessage({type:"localstorage",target:"offscreen-doc"},function(e){e&&(e.email_ids&&Storage_update("email_ids",e.email_ids,Generate_netrequest_rules),e.user)&&Storage_update("user",e.user),chrome.offscreen.closeDocument()})})})}),chrome.runtime.setUninstallURL(window.LOCATION_MAIN+"uninstall?version="+encodeURIComponent(chrome.runtime.getManifest().version)),function(){chrome.declarativeNetRequest.getSessionRules(e=>{e=e.map(e=>e.id);0<e.length&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:e},()=>{})}),chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs.forEach(function(t){chrome.runtime.getManifest().content_scripts[0].matches.forEach(function(e){~t.url.indexOf(e.replace("*://*.","").replace("*://","").replace("/*",""))&&chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},func:function(){return!!document.querySelector("html[data-emailtracker-initialized]")}},function(e){e&&!e[0].result&&(chrome.runtime.getManifest().content_scripts[0].js.forEach(function(e){chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},files:[e]})}),chrome.runtime.getManifest().content_scripts[0].css.forEach(function(e){chrome.scripting.insertCSS({target:{tabId:t.id,allFrames:!0},files:[e]})}))})})})})})});function Generate_netrequest_rules(){chrome.declarativeNetRequest.getDynamicRules(o=>{try{const i=[];Storage_get("email_ids",function(t){(t?JSON.parse(t):[]).forEach(function(t){window.LOCATION_TRACKERS_V.forEach(function(e){i.push({id:i.length+1,priority:1,action:{type:"block"},condition:{urlFilter:e+"?u="+t+"&",resourceTypes:["main_frame","image"]}})})}),["*://*.googleusercontent.com/*","*://*.yusercontent.com/*","*://*.outlook.com/proxy/*","*://*.office.net/imageproxy/*"].forEach((o,e)=>{(t?JSON.parse(t):[]).forEach(function(t){window.LOCATION_TRACKERS_V.forEach(function(e){i.push({id:i.length+1,priority:1,action:{type:"block"},condition:{urlFilter:o+"#*"+e+"?u="+t+"&",resourceTypes:["main_frame","image"]}}),i.push({id:i.length+1,priority:1,action:{type:"block"},condition:{urlFilter:o+"#*"+encodeURIComponent(e+"?u="+t+"&"),resourceTypes:["main_frame","image"]}}),i.push({id:i.length+1,priority:1,action:{type:"block"},condition:{urlFilter:o+"?*"+encodeURIComponent(e+"?u="+t+"&"),resourceTypes:["main_frame","image"]}})})})}),Detector_config(function(e){i.push({action:{type:"allow"},priority:2,id:i.length+1,condition:{urlFilter:"*://*/*#"+e.whitelist_url_string,resourceTypes:["image"]}}),1==e.block&&(i.push({action:{type:"block"},priority:1,id:i.length+1,condition:{regexFilter:"https://(.*).googleusercontent.com/(proxy|meips)/(.*)#(.*)",resourceTypes:["image"],initiatorDomains:["mail.google.com"]}}),i.push({action:{type:"block"},priority:1,id:i.length+1,condition:{urlFilter:"*://*.yusercontent.com/mail?url=*",resourceTypes:["image"],initiatorDomains:["mail.yahoo.com"]}})),chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:o.map(e=>e.id),addRules:i})})})}catch(e){Error_report(850,e)}})}function Feed_item(c){if(c&&c.data&&c.data.email)switch(c.data.a){case"view":case"view_link":Storage_get("notifications_disabled",function(n){Storage_get("feed_mute",function(e){e&&~e.indexOf(c.data.email)||Storage_get("settings",function(a){a=a||{},Storage_get("cache_emails",function(e){var t="";if(e)for(var o in e)c.data.user==e[o]&&(t=o);Storage_get("feed",function(r){r=r||[],Storage_get("feed_unopened",function(i){i=i||[],Storage_get("feed_clicks",function(e){e=e||[];var o=0;try{r.forEach(function(e,t){if(e&&e.id_source===c.data.email)throw r[t]=null,o=1,{}})}catch(e){}r.push({id_source:c.data.email,id:c.data.id_email,time:c.data.time,views:c.data.views,user:t}),Storage_update("feed",r);try{i.forEach(function(e,t){if(e.id_source===c.data.email)throw i.splice(t,1),{}})}catch(e){}Storage_update("feed_unopened",i),c.data.link&&(e.push({id_source:c.data.email,id:c.data.id_email,time:c.data.time,user:t,link:c.data.link}),Storage_update("feed_clicks",e)),Storage_update("feed_updated","1"),n||(chrome.action.getBadgeText({},function(e){chrome.action.setBadgeText({text:String(e?parseInt(e)+1:1)})}),a.notifications_desktop&&(!o||"view"===c.data.a&&a.notifications_extra_all||"view_link"===c.data.a&&a.notifications_extra_links)&&Storage_get("feed_info",function(e){function o(){(i=i||{}).subject||(i.subject="An email");var o=i.link||Tracker_email_link(c.data.email,t,c.data.id_email);chrome.notifications.create("",{type:"basic",title:c.data.link?'"'+c.data.link+'" was clicked on "'+i.subject+'"':'"'+i.subject+'" was opened',message:"Click to view email or reply",contextMessage:i.to?i.to[0]+(i.to[1]?" +"+(i.to.length-1)+" More":""):i.email,isClickable:!0,iconUrl:"image/icon.png"},function(t){chrome.notifications.onClicked.addListener(function(e){t===e&&(o?chrome.tabs.create({url:o}):(Error_report(411),alert(__("error_feed_info"))))})})}var i=(e=e||{})[c.data.email];i?o():Xtion_fetch(window.LOCATION_ACTION+"email_information_get",function(t){t&&Storage_get("feed_info",function(e){e=e||{},(i=JSON.parse(t)).to=i.to.split(", "),e[c.data.email]=i,Storage_update("feed_info",e)}),o()},{post:{email:c.data.id_email}})})),a.notifications_desktop&&(!o||"view"===c.data.a&&a.notifications_extra_all||"view_link"===c.data.a&&a.notifications_extra_links)||Storage_get("user_pro",function(e){e&&Storage_get("feed_info",function(e){(e=e||{})[c.data.email]||Xtion_fetch(window.LOCATION_ACTION+"email_information_get",function(t){t&&Storage_get("feed_info",function(e){(e=e||{})[c.data.email]=JSON.parse(t),e[c.data.email].to=e[c.data.email].to.split(", "),Storage_update("feed_info",e)})},{post:{email:c.data.id_email}})})}),chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs.forEach(function(t){chrome.runtime.getManifest().content_scripts[0].matches.forEach(function(e){~t.url.indexOf(e.replace("*://*.","").replace("/*",""))&&chrome.scripting.executeScript({target:{tabId:t.id,allFrames:!0},func:function(e){for(var t=document.querySelectorAll('.emailtracker_status[data-id="'+e+'"]'),o=t.length;o--;){var i=t[o];i.removeChild(i.firstChild),i.insertAdjacentHTML("afterBegin","&#10003;"),i.setAttribute("data-status",1),i.firstElementChild&&i.firstElementChild.removeAttribute("data-emailtracker")}},args:[c.data.email.replace(/'/g,"").replace(/"/g,"")]})})})})})})})})})})})})}else Error_report(800,"Missing GCM message id_source",JSON.stringify(c.data),null,{debug_report:1})}function Feed_sync(){Storage_get("user_pro",function(r){window.feed_sync_delay_skip++,(r||6<=window.feed_sync_delay_skip)&&(window.feed_sync_delay_skip=0,Storage_get("feed_unopened",function(e){if(e){e=e.reverse();for(var o=[],i=0;i<e.length&&i<200;i++)e[i].id&&o.push({id:e[i].id,id_source:e[i].id_source});o.length&&Xtion_fetch(window.LOCATION_ACTION+"sync_email_ids",function(e){(e=JSON.parse(e))&&e.hasOwnProperty("pro")&&(1!=e.pro||r?0==e.pro&&r&&(Storage_update("user_pro",0),Detector_config(function(e){e.hasOwnProperty("block")&&1==e.block&&(e.block=0,Detector_config_update(e),chrome.tabs.sendMessage(t.id,{a:"detector_config_update"}))})):Storage_update("user_pro",1)),(e=e.emails)&&e.length&&e.forEach(function(e){Feed_item({data:Xtion_object_merge({a:"view"},e)})})},{post:{emails:o,pro_check:1},timeout:3e4})}}))})}setTimeout(refresh_contentscripts,1e3),Generate_netrequest_rules(),function o(){Storage_get("notify",function(e){e||chrome.instanceID.getToken({authorizedEntity:window.PUSH_GCM_ID,scope:"GCM"},function(t){chrome.runtime.lastError?(window.notifications_register_retry?window.notifications_register_retry++:window.notifications_register_retry=1,window.notifications_register_retry<5&&setTimeout(function(){o()},1e3*window.notifications_register_retry)):Xtion_fetch(window.LOCATION_ACTION+"notification_register",function(e){"{"===e.substring(0,1)?Storage_update("notify",Xtion_object_merge(JSON.parse(e),{push:t})):Error_report(601,e)},{post:{id:t},retry:3})})})}(),window.feed_sync_delay_skip=0,chrome.gcm.onMessage.addListener(Feed_item),chrome.gcm.onMessagesDeleted.addListener(Feed_sync),Feed_sync(),chrome.alarms.onAlarm.addListener(e=>{"feed_sync"===e.name&&Feed_sync()}),chrome.alarms.get("feed_sync",function(e){e||chrome.alarms.create({periodInMinutes:15},function(){})}),chrome.runtime.onConnect.addListener(function(e){e.onMessage.addListener(function(e){})});
